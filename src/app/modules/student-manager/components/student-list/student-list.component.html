<!--
  ~ Copyright 2020-2022 Aion Technology LLC
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<div class="spinner-container" *ngIf="isLoading(studentCacheService.isLoading | async)">
  <mat-progress-spinner color="primary" mode="indeterminate" [diameter]="100" [strokeWidth]="10"></mat-progress-spinner>
</div>

<div class="bg">
  <div class="list-container mat-elevation-z2">

    <div class="header">
      <div *ngIf="userSession.isSysAdmin">
        <mat-form-field>
          <mat-label>Select a school</mat-label>
          <mat-select [(ngModel)]="selectedSchool">
            <mat-option *ngFor="let school of (schools$ | async)" [value]="school"
                        [routerLink]="['/studentmanager', 'schools', school.id]">
              {{ school.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>
        <div class="spacer"></div>
      </div>
      <mat-form-field *ngIf="isSchoolSelected">
        <input matInput [(ngModel)]="studentCacheService.filterBinding"
               (keyup)="studentCacheService.applyFilter($event.target.value)" placeholder="Filter"/>
        <button mat-button *ngIf="studentCacheService.filter" matSuffix mat-icon-button
                (click)="studentCacheService.clearFilter()">
          <mat-icon>close</mat-icon>
        </button>
      </mat-form-field>
      <div class="spacer"></div>
      <mat-form-field *ngIf="isSchoolSelected">
        <mat-label>Session</mat-label>
        <mat-select [(ngModel)]="selectedSession" (selectionChange)="updateSession()">
          <mat-option *ngFor="let session of (schoolSessions$ | async)" [value]="session">
            {{ session.labelWithCurrent }}
          </mat-option>
        </mat-select>
      </mat-form-field>
      <div class="notification mat-h5" *ngIf="isSchoolSelected && !selectedSession?.isCurrent">
        Historic Data (Read Only)
      </div>
    </div>

    <div *ngIf="isSchoolSelected">
      <table mat-table [dataSource]="studentCacheService.tableDataSource" matSort>
        <ng-container matColumnDef="select">
          <th mat-header-cell *matHeaderCellDef>
            <mat-checkbox
              (change)="$event ? studentCacheService.masterToggle() : null"
              [checked]="studentCacheService.selection.hasValue() && studentCacheService.isAllSelected()"
              [indeterminate]="studentCacheService.selection.hasValue() && !studentCacheService.isAllSelected()"
            >
            </mat-checkbox>
          </th>
          <td mat-cell *matCellDef="let row">
            <mat-checkbox *ngIf="selectedSession?.isCurrent"
                          (click)="$event.stopPropagation()"
                          (change)="$event ? studentCacheService.selection.toggle(row) : null"
                          [checked]="studentCacheService.selection.isSelected(row)"
            >
            </mat-checkbox>
          </td>
        </ng-container>

        <ng-container matColumnDef="firstName">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>First Name</th>
          <td mat-cell *matCellDef="let student">
            <a [routerLink]="['students', student.id]"
               [queryParams]="{session: selectedSession?.id, historic: !selectedSession.isCurrent}">
              {{ student.firstName }}
            </a>
          </td>
        </ng-container>

        <ng-container matColumnDef="lastName">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Last Name</th>
          <td mat-cell *matCellDef="let student">{{ student.lastName }}</td>
        </ng-container>

        <ng-container matColumnDef="studentId">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>ID</th>
          <td mat-cell *matCellDef="let student">{{ student.studentId }}</td>
        </ng-container>

        <ng-container matColumnDef="grade">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Grade</th>
          <td mat-cell *matCellDef="let student">{{ studentGrade(student) }}</td>
        </ng-container>

        <ng-container matColumnDef="teacher">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Teacher</th>
          <td mat-cell *matCellDef="let student">
            {{ student.teacherName || "&lt;Not Set&gt;" }}
          </td>
        </ng-container>

        <ng-container matColumnDef="preferredTime">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Meeting Time</th>
          <td mat-cell *matCellDef="let student">{{ student.preferredTime }}</td>
        </ng-container>

        <ng-container matColumnDef="contacts">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Contacts</th>
          <td mat-cell *matCellDef="let student">
            <ul>
              <div *ngIf="!student.contacts.length">
                <li>
                  N/A
                </li>
              </div>
              <div *ngFor="let contact of student.contacts">
                <li>
                  {{ displayContact(contact) }}
                </li>
              </div>
            </ul>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns(); sticky: true"></tr>
        <tr
          mat-row
          *matRowDef="let row; columns: displayedColumns()"
          (click)="studentCacheService.selection.toggle(row)"
        ></tr>
      </table>

      <table class="footer mat-elevation-z1">
        <tr>
          <td>
            <ms-selection-count-display
              [selectionCount]="studentCacheService.selectionCount"></ms-selection-count-display>
          </td>
          <td>
            <mat-paginator #paginator [pageSize]="studentCacheService.pageSize"
                           [pageSizeOptions]="[10, 20, 50]"></mat-paginator>
          </td>
        </tr>
      </table>
    </div>

  </div>
</div>
